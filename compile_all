#!/bin/bash

#LOG_FILE=compile.log

#exec > $LOGFILE 2>&1
#exec > $PIPEFILE 2>&1
#tee $LOGFILE < $PIPEFILE &
#TEEPID=$!

SCRIPT_ROOT="/home/scottshotgg/Development/remote-chessbase-stockfish-hijack"

# Ensure that we are in correct directory so that this file can be run from anywhere
cd $SCRIPT_ROOT


# Test if they have specified the amount of cores to use, if not just pull them from proc
if [ -z "$1" ]; then
	cores=$(cat /proc/cpuinfo | awk '/^processor/{print $3}' | tail -1)
	cores=$(expr $cores + 1)
else
	cores=$1
fi


echo
echo "Using $cores cores to compile with -j $(expr $cores + 1)"
echo
echo

rm -rf $SCRIPT_ROOT/executables/
mkdir $SCRIPT_ROOT/executables/

echo "Building the server executable"
go build -o $SCRIPT_ROOT/executables/server $SCRIPT_ROOT/server/main.go &

GOOS=windows GOARCH=amd64 go build -o $SCRIPT_ROOT/executables/server.exe $SCRIPT_ROOT/server/main.go &

echo "Building the hijacked version executable"
cd $SCRIPT_ROOT/hijacked_stockfish/src/
./compile $(expr $cores + 1) &

echo "Building the official version executable"
cd $SCRIPT_ROOT/stockfish/src/
./compile $(expr $cores + 1) &

echo $(pwd)
#cp *.exe ~/VirtualBox\ VMs/Folder/
cd $SCRIPT_ROOT/executables

echo
echo
echo "*****"
echo
echo "Done compiling both releases and the server."
echo "There is now a folder at the root named 'executables' where they are all stored."
echo
echo "*****"
echo
echo


#exec 1>&- 2>&-
#wait $TEEPID